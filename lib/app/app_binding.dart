// import 'package:get/get.dart';
// import 'package:connectivity_plus/connectivity_plus.dart';

// import 'package:baudex_desktop/app/core/network/dio_client.dart';
// import 'package:baudex_desktop/app/core/network/network_info.dart';
// import 'package:baudex_desktop/app/core/storage/secure_storage_service.dart';
// import 'package:baudex_desktop/features/auth/data/datasources/auth_remote_datasource.dart';
// import 'package:baudex_desktop/features/auth/data/datasources/auth_local_datasource.dart';
// import 'package:baudex_desktop/features/auth/data/repositories/auth_repository_impl.dart';
// import 'package:baudex_desktop/features/auth/domain/repositories/auth_repository.dart';
// import 'package:baudex_desktop/features/auth/domain/usecases/is_authenticated_usecase.dart';
// import 'package:baudex_desktop/features/auth/domain/usecases/login_usecase.dart';
// import 'package:baudex_desktop/features/auth/domain/usecases/logout_usecase.dart';
// import 'package:baudex_desktop/features/auth/domain/usecases/register_usecase.dart';
// import 'package:baudex_desktop/features/auth/domain/usecases/get_profile_usecase.dart';
// import 'package:baudex_desktop/features/auth/domain/usecases/change_password_usecase.dart';
// import 'package:baudex_desktop/features/auth/presentation/controllers/auth_controller.dart';

// class InitialBinding implements Bindings {
//   @override
//   void dependencies() {
//     // ==================== CORE DEPENDENCIES ====================
//     Get.lazyPut(() => DioClient(), fenix: true);
//     Get.lazyPut(() => SecureStorageService(), fenix: true);
//     Get.lazyPut<Connectivity>(() => Connectivity(), fenix: true);
//     Get.lazyPut<NetworkInfo>(
//       () => NetworkInfoImpl(Get.find<Connectivity>()),
//       fenix: true,
//     );

//     // ==================== AUTH DATA LAYER ====================
//     Get.lazyPut<AuthRemoteDataSource>(
//       () => AuthRemoteDataSourceImpl(dioClient: Get.find()),
//       fenix: true,
//     );
//     Get.lazyPut<AuthLocalDataSource>(
//       () => AuthLocalDataSourceImpl(storageService: Get.find()),
//       fenix: true,
//     );
//     Get.lazyPut<AuthRepository>(
//       () => AuthRepositoryImpl(
//         remoteDataSource: Get.find(),
//         localDataSource: Get.find(),
//         networkInfo: Get.find(),
//       ),
//       fenix: true,
//     );

//     // ==================== AUTH USE CASES ====================
//     Get.lazyPut(() => LoginUseCase(Get.find()), fenix: true);
//     Get.lazyPut(() => LogoutUseCase(Get.find()), fenix: true);
//     Get.lazyPut(() => IsAuthenticatedUseCase(Get.find()), fenix: true);
//     Get.lazyPut(() => RegisterUseCase(Get.find()), fenix: true);
//     Get.lazyPut(() => GetProfileUseCase(Get.find()), fenix: true);
//     Get.lazyPut(() => ChangePasswordUseCase(Get.find()), fenix: true);

//     // ==================== AUTH CONTROLLER (Permanent) ====================
//     Get.put(
//       AuthController(
//         loginUseCase: Get.find(),
//         logoutUseCase: Get.find(),
//         isAuthenticatedUseCase: Get.find(),
//         registerUseCase: Get.find(),
//         getProfileUseCase: Get.find(),
//         changePasswordUseCase: Get.find(),
//       ),
//       permanent: true,
//     );
//   }

//   @override
//   void onDispose() {
//     // Solo eliminar dependencias no permanentes si es necesario
//     // Las dependencias con fenix: true se auto-gestionan
//     // Las dependencias permanent: true no deben eliminarse aqu√≠
//   }
// }

// lib/app/app_binding.dart
import 'package:get/get.dart';
import 'package:connectivity_plus/connectivity_plus.dart';

// ==================== CORE IMPORTS ====================
import 'package:baudex_desktop/app/core/network/dio_client.dart';
import 'package:baudex_desktop/app/core/network/network_info.dart';
import 'package:baudex_desktop/app/core/storage/secure_storage_service.dart';
import 'package:baudex_desktop/app/core/services/file_service.dart';

// ==================== AUTH IMPORTS ====================
import 'package:baudex_desktop/features/auth/data/datasources/auth_remote_datasource.dart';
import 'package:baudex_desktop/features/auth/data/datasources/auth_local_datasource.dart';
import 'package:baudex_desktop/features/auth/data/repositories/auth_repository_impl.dart';
import 'package:baudex_desktop/features/auth/domain/repositories/auth_repository.dart';
import 'package:baudex_desktop/features/auth/domain/usecases/is_authenticated_usecase.dart';
import 'package:baudex_desktop/features/auth/domain/usecases/login_usecase.dart';
import 'package:baudex_desktop/features/auth/domain/usecases/logout_usecase.dart';
import 'package:baudex_desktop/features/auth/domain/usecases/register_usecase.dart';
import 'package:baudex_desktop/features/auth/domain/usecases/get_profile_usecase.dart';
import 'package:baudex_desktop/features/auth/domain/usecases/change_password_usecase.dart';
import 'package:baudex_desktop/features/auth/presentation/controllers/auth_controller.dart';

// ==================== TENANT IMPORTS ====================
import 'package:baudex_desktop/core/storage/tenant_storage.dart';

// ==================== CUSTOMER IMPORTS ====================
import 'package:baudex_desktop/features/customers/presentation/bindings/customer_binding.dart';
import 'package:baudex_desktop/features/customers/domain/repositories/customer_repository.dart';
import 'package:baudex_desktop/features/customers/domain/usecases/get_customer_by_id_usecase.dart';
import 'package:baudex_desktop/features/customers/domain/usecases/get_customers_usecase.dart';
import 'package:baudex_desktop/features/customers/domain/usecases/search_customers_usecase.dart';

// ==================== SHARED UI IMPORTS ====================
import 'package:baudex_desktop/app/shared/controllers/app_drawer_controller.dart';

// ==================== SETTINGS IMPORTS ====================
import 'package:baudex_desktop/features/settings/presentation/bindings/settings_binding.dart';

// ==================== DASHBOARD IMPORTS ====================
import 'package:baudex_desktop/features/dashboard/presentation/bindings/dashboard_binding.dart';
import 'package:baudex_desktop/features/dashboard/domain/repositories/dashboard_repository.dart';
import 'package:baudex_desktop/features/dashboard/domain/usecases/get_dashboard_stats_usecase.dart';
import 'package:baudex_desktop/features/dashboard/presentation/controllers/dashboard_controller.dart';

// ==================== PRODUCT IMPORTS ====================
// TODO: Descomentar cuando tengas ProductBinding
// import 'package:baudex_desktop/features/products/presentation/bindings/product_binding.dart';
// import 'package:baudex_desktop/features/products/domain/repositories/product_repository.dart';
// import 'package:baudex_desktop/features/products/domain/usecases/get_products_usecase.dart';
// import 'package:baudex_desktop/features/products/domain/usecases/search_products_usecase.dart';

class InitialBinding implements Bindings {
  @override
  void dependencies() {
    print('üöÄ InitialBinding: Iniciando dependencias globales...');
    print('üì± Modo: PRODUCCI√ìN');

    // ==================== CORE DEPENDENCIES ====================
    _registerCoreDependencies();

    // ==================== SHARED UI CONTROLLERS ====================
    _registerSharedUIControllers();

    // ==================== AUTH MODULE ====================
    _registerAuthModule();

    // ==================== CUSTOMER MODULE ====================
    _registerCustomerModule();

    // ==================== PRODUCT MODULE ====================
    _registerProductModule();

    // ==================== SETTINGS MODULE ====================
    _registerSettingsModule();

    // ==================== DASHBOARD MODULE ====================
    print('üè† [DEBUG] A PUNTO DE LLAMAR _registerDashboardModule()...');
    _registerDashboardModule();
    print('üè† [DEBUG] _registerDashboardModule() COMPLETADO');

    // ==================== VALIDACI√ìN FINAL ====================
    _validateDependencies();

    print(
      'üéâ InitialBinding: Todas las dependencias globales registradas exitosamente',
    );
  }

  /// Registrar dependencias core del sistema
  void _registerCoreDependencies() {
    print('üì¶ Registrando dependencias core...');

    Get.lazyPut(() => DioClient(), fenix: true);
    Get.lazyPut(() => SecureStorageService(), fenix: true);
    Get.lazyPut<Connectivity>(() => Connectivity(), fenix: true);
    Get.lazyPut<NetworkInfo>(
      () => NetworkInfoImpl(Get.find<Connectivity>()),
      fenix: true,
    );
    
    // Tenant Storage para multitenant
    Get.lazyPut<TenantStorage>(
      () => TenantStorageImpl(Get.find<SecureStorageService>()),
      fenix: true,
    );
    
    // File Service para manejo de archivos
    Get.lazyPut<FileService>(
      () => FileServiceImpl(),
      fenix: true,
    );

    print('‚úÖ Dependencias core registradas');
  }

  /// Registrar controladores compartidos de UI
  void _registerSharedUIControllers() {
    print('üé® Registrando controladores de UI compartidos...');

    try {
      // AppDrawer Controller (global para navegaci√≥n)
      Get.lazyPut<AppDrawerController>(
        () => AppDrawerController(),
        fenix: true,
      );

      print('‚úÖ Controladores de UI compartidos registrados');
      print('   - AppDrawerController: ‚úÖ');
    } catch (e) {
      print('‚ùå Error registrando controladores de UI: $e');
      rethrow;
    }
  }

  /// Registrar m√≥dulo de autenticaci√≥n
  void _registerAuthModule() {
    print('üîê Registrando m√≥dulo de autenticaci√≥n...');

    try {
      // AUTH DATA LAYER
      Get.lazyPut<AuthRemoteDataSource>(
        () => AuthRemoteDataSourceImpl(dioClient: Get.find()),
        fenix: true,
      );
      Get.lazyPut<AuthLocalDataSource>(
        () => AuthLocalDataSourceImpl(storageService: Get.find()),
        fenix: true,
      );
      Get.lazyPut<AuthRepository>(
        () => AuthRepositoryImpl(
          remoteDataSource: Get.find(),
          localDataSource: Get.find(),
          networkInfo: Get.find(),
        ),
        fenix: true,
      );

      // AUTH USE CASES
      Get.lazyPut(() => LoginUseCase(Get.find()), fenix: true);
      Get.lazyPut(() => LogoutUseCase(Get.find()), fenix: true);
      Get.lazyPut(() => IsAuthenticatedUseCase(Get.find()), fenix: true);
      Get.lazyPut(() => RegisterUseCase(Get.find()), fenix: true);
      Get.lazyPut(() => GetProfileUseCase(Get.find()), fenix: true);
      Get.lazyPut(() => ChangePasswordUseCase(Get.find()), fenix: true);

      // AUTH CONTROLLER (Permanent)
      Get.put(
        AuthController(
          loginUseCase: Get.find(),
          logoutUseCase: Get.find(),
          isAuthenticatedUseCase: Get.find(),
          registerUseCase: Get.find(),
          getProfileUseCase: Get.find(),
          changePasswordUseCase: Get.find(),
          tenantStorage: Get.find<TenantStorage>(),
        ),
        permanent: true,
      );

      print('‚úÖ M√≥dulo de autenticaci√≥n registrado');
    } catch (e) {
      print('‚ùå Error registrando m√≥dulo de autenticaci√≥n: $e');
      rethrow; // En producci√≥n, fallar si auth no se puede inicializar
    }
  }

  /// Registrar m√≥dulo de clientes
  void _registerCustomerModule() {
    print('üë• Registrando m√≥dulo de clientes...');

    try {
      // Inicializar CustomerBinding que incluye todas las dependencias de Customer
      CustomerBinding().dependencies();

      // Verificar que las dependencias cr√≠ticas est√©n disponibles
      final isCustomerRepoRegistered = Get.isRegistered<CustomerRepository>();
      final isGetCustomerByIdRegistered =
          Get.isRegistered<GetCustomerByIdUseCase>();

      if (isCustomerRepoRegistered && isGetCustomerByIdRegistered) {
        print('‚úÖ M√≥dulo de clientes registrado correctamente');
        print('   - CustomerRepository: ‚úÖ');
        print('   - GetCustomerByIdUseCase: ‚úÖ');
        print(
          '   - GetCustomersUseCase: ${Get.isRegistered<GetCustomersUseCase>() ? "‚úÖ" : "‚ùå"}',
        );
        print(
          '   - SearchCustomersUseCase: ${Get.isRegistered<SearchCustomersUseCase>() ? "‚úÖ" : "‚ùå"}',
        );
      } else {
        throw Exception(
          'Dependencias cr√≠ticas de Customer no se registraron correctamente',
        );
      }
    } catch (e) {
      print('‚ùå Error registrando m√≥dulo de clientes: $e');
      print(
        '‚ö†Ô∏è ADVERTENCIA: InvoiceFormController usar√° datos mock para clientes',
      );
      // En producci√≥n, podr√≠as decidir si quieres fallar aqu√≠ o continuar
      // rethrow; // Descomenta si quieres fallar en caso de error
    }
  }

  /// Registrar m√≥dulo de productos
  void _registerProductModule() {
    print('üì¶ Registrando m√≥dulo de productos...');

    try {
      // TODO: Cuando tengas ProductBinding, descomenta estas l√≠neas:
      /*
      ProductBinding().dependencies();
      
      final isProductRepoRegistered = Get.isRegistered<ProductRepository>();
      final isGetProductsRegistered = Get.isRegistered<GetProductsUseCase>();
      
      if (isProductRepoRegistered && isGetProductsRegistered) {
        print('‚úÖ M√≥dulo de productos registrado correctamente');
        print('   - ProductRepository: ‚úÖ');
        print('   - GetProductsUseCase: ‚úÖ');
        print('   - SearchProductsUseCase: ${Get.isRegistered<SearchProductsUseCase>() ? "‚úÖ" : "‚ùå"}');
      } else {
        throw Exception('Dependencias cr√≠ticas de Product no se registraron correctamente');
      }
      */

      // ‚úÖ TEMPORAL: Mientras no tengas ProductBinding
      print('‚ö†Ô∏è ProductBinding no implementado a√∫n');
      print('‚ÑπÔ∏è InvoiceFormController usar√° datos mock para productos');
    } catch (e) {
      print('‚ùå Error registrando m√≥dulo de productos: $e');
      print(
        '‚ö†Ô∏è ADVERTENCIA: InvoiceFormController usar√° datos mock para productos',
      );
      // En producci√≥n, podr√≠as decidir si quieres fallar aqu√≠ o continuar
    }
  }

  /// Registrar m√≥dulo de configuraciones
  void _registerSettingsModule() {
    print('‚öôÔ∏è Registrando m√≥dulo de configuraciones...');

    try {
      // Inicializar SettingsBinding que incluye todas las dependencias de Settings
      SettingsBinding().dependencies();

      print('‚úÖ M√≥dulo de configuraciones registrado correctamente');
      print('   - IsarService: ‚úÖ');
      print('   - SettingsRepository: ‚úÖ');
      print('   - SettingsController: ‚úÖ');
    } catch (e) {
      print('‚ùå Error registrando m√≥dulo de configuraciones: $e');
      print('‚ö†Ô∏è ADVERTENCIA: Las configuraciones no estar√°n disponibles');
      // No fallar en caso de error para no bloquear la app
    }
  }

  /// Registrar m√≥dulo de dashboard como GLOBAL PERMANENTE
  void _registerDashboardModule() {
    print('üè† [DEBUG] INICIANDO _registerDashboardModule()...');
    print('üè† Registrando m√≥dulo de dashboard como GLOBAL...');

    try {
      // Inicializar DashboardBinding como dependencias GLOBALES permanentes
      DashboardBinding().dependencies();

      // Verificar que las dependencias cr√≠ticas est√©n disponibles
      final isDashboardRepoRegistered = Get.isRegistered<DashboardRepository>();
      final isDashboardStatsRegistered = Get.isRegistered<GetDashboardStatsUseCase>();
      final isDashboardControllerRegistered = Get.isRegistered<DashboardController>();

      if (isDashboardRepoRegistered && isDashboardStatsRegistered && isDashboardControllerRegistered) {
        print('‚úÖ M√≥dulo de dashboard registrado como GLOBAL correctamente');
        print('   - DashboardRepository: ‚úÖ');
        print('   - GetDashboardStatsUseCase: ‚úÖ');
        print('   - DashboardController: ‚úÖ');
        print('   üî• IMPORTANTE: Dashboard persistir√° entre navegaciones');
      } else {
        throw Exception(
          'Dependencias cr√≠ticas de Dashboard no se registraron correctamente',
        );
      }
    } catch (e) {
      print('‚ùå Error registrando m√≥dulo de dashboard: $e');
      print('‚ö†Ô∏è ADVERTENCIA: Dashboard se comportar√° de forma est√°ndar (sin persistencia)');
      // No fallar en caso de error para no bloquear la app
    }
  }

  /// Validar que todas las dependencias cr√≠ticas est√©n registradas
  void _validateDependencies() {
    print('üîç Validando dependencias cr√≠ticas...');

    final criticalDependencies = {
      'DioClient': Get.isRegistered<DioClient>(),
      'NetworkInfo': Get.isRegistered<NetworkInfo>(),
      'SecureStorageService': Get.isRegistered<SecureStorageService>(),
      'AuthRepository': Get.isRegistered<AuthRepository>(),
      'AuthController': Get.isRegistered<AuthController>(),
      'CustomerRepository': Get.isRegistered<CustomerRepository>(),
      'GetCustomerByIdUseCase': Get.isRegistered<GetCustomerByIdUseCase>(),
      'DashboardRepository': Get.isRegistered<DashboardRepository>(),
      'GetDashboardStatsUseCase': Get.isRegistered<GetDashboardStatsUseCase>(),
      'DashboardController': Get.isRegistered<DashboardController>(),
    };

    final failedDependencies =
        criticalDependencies.entries
            .where((entry) => !entry.value)
            .map((entry) => entry.key)
            .toList();

    if (failedDependencies.isEmpty) {
      print('‚úÖ Todas las dependencias cr√≠ticas est√°n registradas');
    } else {
      print('‚ùå Dependencias cr√≠ticas faltantes:');
      for (String dependency in failedDependencies) {
        print('   - $dependency');
      }
      throw Exception(
        'Faltan dependencias cr√≠ticas: ${failedDependencies.join(", ")}',
      );
    }
  }

  @override
  void onDispose() {
    print('üßπ InitialBinding: Limpiando dependencias...');
    // Solo eliminar dependencias no permanentes si es necesario
    // Las dependencias con fenix: true se auto-gestionan
    // Las dependencias permanent: true no deben eliminarse aqu√≠
  }

  /// M√©todo para debugging en desarrollo
  static void debugDependencies() {
    print('üîç DEBUG: Estado completo de dependencias globales:');

    // Core
    print('üì¶ Core Dependencies:');
    print('   - DioClient: ${Get.isRegistered<DioClient>() ? "‚úÖ" : "‚ùå"}');
    print('   - NetworkInfo: ${Get.isRegistered<NetworkInfo>() ? "‚úÖ" : "‚ùå"}');
    print(
      '   - SecureStorageService: ${Get.isRegistered<SecureStorageService>() ? "‚úÖ" : "‚ùå"}',
    );
    print('   - Connectivity: ${Get.isRegistered<Connectivity>() ? "‚úÖ" : "‚ùå"}');

    // Auth
    print('üîê Auth Dependencies:');
    print(
      '   - AuthRepository: ${Get.isRegistered<AuthRepository>() ? "‚úÖ" : "‚ùå"}',
    );
    print(
      '   - AuthController: ${Get.isRegistered<AuthController>() ? "‚úÖ" : "‚ùå"}',
    );
    print('   - LoginUseCase: ${Get.isRegistered<LoginUseCase>() ? "‚úÖ" : "‚ùå"}');
    print(
      '   - LogoutUseCase: ${Get.isRegistered<LogoutUseCase>() ? "‚úÖ" : "‚ùå"}',
    );

    // Customer
    print('üë• Customer Dependencies:');
    print(
      '   - CustomerRepository: ${Get.isRegistered<CustomerRepository>() ? "‚úÖ" : "‚ùå"}',
    );
    print(
      '   - GetCustomerByIdUseCase: ${Get.isRegistered<GetCustomerByIdUseCase>() ? "‚úÖ" : "‚ùå"}',
    );
    print(
      '   - GetCustomersUseCase: ${Get.isRegistered<GetCustomersUseCase>() ? "‚úÖ" : "‚ùå"}',
    );
    print(
      '   - SearchCustomersUseCase: ${Get.isRegistered<SearchCustomersUseCase>() ? "‚úÖ" : "‚ùå"}',
    );

    // Product (cuando est√© implementado)
    print('üì¶ Product Dependencies:');
    print('   - ProductRepository: ‚ö†Ô∏è No implementado');
    print('   - GetProductsUseCase: ‚ö†Ô∏è No implementado');
    print('   - SearchProductsUseCase: ‚ö†Ô∏è No implementado');

    print('üèÅ Debug completado');
  }

  /// M√©todo para obtener un reporte de estado
  static Map<String, dynamic> getDependencyReport() {
    return {
      'core': {
        'DioClient': Get.isRegistered<DioClient>(),
        'NetworkInfo': Get.isRegistered<NetworkInfo>(),
        'SecureStorageService': Get.isRegistered<SecureStorageService>(),
      },
      'auth': {
        'AuthRepository': Get.isRegistered<AuthRepository>(),
        'AuthController': Get.isRegistered<AuthController>(),
      },
      'customer': {
        'CustomerRepository': Get.isRegistered<CustomerRepository>(),
        'GetCustomerByIdUseCase': Get.isRegistered<GetCustomerByIdUseCase>(),
        'GetCustomersUseCase': Get.isRegistered<GetCustomersUseCase>(),
        'SearchCustomersUseCase': Get.isRegistered<SearchCustomersUseCase>(),
      },
      'product': {
        'ProductRepository': false, // Temporal
        'GetProductsUseCase': false, // Temporal
        'SearchProductsUseCase': false, // Temporal
      },
      'timestamp': DateTime.now().toIso8601String(),
    };
  }
}
